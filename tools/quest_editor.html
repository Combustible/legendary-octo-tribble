<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Monumenta Quest Editor</title>

    <!-- Foundation CSS framework (Bootstrap and jQueryUI also supported) -->
    <link rel='stylesheet' href='//cdn.jsdelivr.net/bootstrap/3.2.0/css/bootstrap.css'>
    <!-- Font Awesome icons (Bootstrap, Foundation, and jQueryUI also supported) -->
    <link rel='stylesheet' href='//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css'>

    <link rel='stylesheet' href='//cdn.jsdelivr.net/sceditor/1.4.3/jquery.sceditor.default.min.css'>
    <link rel='stylesheet' href='//cdn.jsdelivr.net/sceditor/1.4.3/themes/modern.min.css'>
    <script src='//cdn.jsdelivr.net/jquery/2.1.1/jquery.min.js'></script>
    <script src='//cdn.jsdelivr.net/sceditor/1.4.3/jquery.sceditor.min.js'></script>
    <script src='//cdn.jsdelivr.net/sceditor/1.4.3/plugins/xhtml.js'></script>

    <script src="../dist/jsoneditor.js"></script>
</head>
<body>
<div class='container'>
    <div class='row' style='padding-bottom: 15px;'>
        <div class='col-md-12'>
            <h1>Monumenta Quest Editor</h1>
            <a href="https://hub.spigotmc.org/javadocs/spigot/org/bukkit/entity/EntityType.html">Entity Types</a>
            <br>
            <a href="https://minecraft.gamepedia.com/Formatting_codes">Minecraft Formatting Codes</a>
        </div>
    </div>
    <div class='row' style='padding-bottom: 15px;'>
        <div class='col-md-12'>
            <button id='restore' class='btn btn-info'>Restore to Default</button>
            <span id='valid_indicator' class='label label-success'></span>
        </div>
    </div>
    <div class='row'>
        <div class='col-md-12'>
            <div id='editor_holder'></div>
        </div>
    </div>
</div>

<script>
    JSONEditor.defaults.theme = 'bootstrap3';
    JSONEditor.defaults.iconlib = 'fontawesome4';
    JSONEditor.plugins.sceditor.style = "//cdn.jsdelivr.net/sceditor/1.4.3/jquery.sceditor.default.min.css";

    // Initialize the editor
    var editor = new JSONEditor(document.getElementById('editor_holder'),{
        // The schema for the editor
        schema: {
            title: "Quest",
            defaultProperties: [
                "npc",
                "quest_components"
            ],
            additionalProperties:false,
            properties: {
                npc: {
                    required: true,
                    propertyOrder: 1,
                    title: "npc",
                    description: "NPC's name with spaces and color codes deleted. \"CaptainMurano\" works, \"Captain Murano\" and \"Captain_Murano\" do not.",
                    type: "string"
                },
                display_name: {
                    propertyOrder: 2,
                    title: "display_name",
                    description: "NPC's name as displayed in chat messages sent from the NPC. Can contain spaces and technically colors, though use of colors is generally discouraged here.",
                    type: "string"
                },
                entity_type: {
                    propertyOrder: 3,
                    title: "entity_type",
                    description: "Bukkit/Spigot EntityType. Can be any of these choices: VILLAGER (default), ARMOR_STAND, BAT, BLAZE, CAVE_SPIDER, CHICKEN, COW, CREEPER, DONKEY, ELDER_GUARDIAN, ENDER_DRAGON, ENDERMAN, ENDERMITE, EVOKER, GHAST, GIANT, GUARDIAN, HORSE, HUSK, ILLUSIONER, IRON_GOLEM, LLAMA, MAGMA_CUBE, MULE, MUSHROOM_COW, OCELOT, PARROT, PIG, PIG_ZOMBIE, POLAR_BEAR, RABBIT, SHEEP, SHULKER, SILVERFISH, SKELETON, SKELETON_HORSE, SLIME, SNOWMAN, SPIDER, SQUID, STRAY, VEX, VINDICATOR, WITCH, WITHER, WITHER_SKELETON, WOLF, ZOMBIE, ZOMBIE_HORSE, ZOMBIE_VILLAGER",
                    type: "string"
                },
                quest_components: {
                    required: true,
                    propertyOrder: 4,
                    title: "quest_components",
                    description: "A list of dialog/requirement pairs",
                    type: "array",
                    format: "tabs",
                    minItems: 1,
                    items: {
                        title: "Quest component",
                        $ref: "#/definitions/quest_component"
                    }
                }
            },
            definitions: {
                quest_component: {
                    type: "object",
                    // The object will start with only these properties
                    defaultProperties: [
                        "prerequisites",
                        "actions"
                    ],
                    additionalProperties:false,
                    properties: {
                        prerequisites: {
                            propertyOrder: 1,
                            $ref: "#/definitions/prerequisites"
                        },
                        delay_actions_by_ticks: {
                            propertyOrder: 2,
                            $ref: "#/definitions/delay_actions_by_ticks"
                        },
                        actions: {
                            propertyOrder: 3,
                            required: true,
                            $ref: "#/definitions/actions"
                        }
                    }
                },
                prerequisites: {
                    title: "prerequisites",
                    type: "object",
                    defaultProperties: [],
                    additionalProperties:false,
                    properties: {
                        check_scores: {
                            propertyOrder: 1,
                            title: "check_scores",
                            description: "Checks that the player has the specified scoreboard value(s). Click Properties, then type in the scoreboard name in the input box and click the 'add' button. Scoreboards are case-sensitive",
                            type: "object",
                            patternProperties:{
                                ".*":{
                                    $ref: "#/definitions/check_score"
                                }
                            }
                        },
                        items_in_inventory: {
                            propertyOrder: 2,
                            title: "items_in_inventory",
                            description: "Checks that all of the specified items are present in the player's inventory",
                            type: "array",
                            minItems: 1,
                            items: {
                                title: "Item",
                                description: "Checks that a specific item stack exists in the player's inventory. All conditions given here must match to succeed. All fields are optional, but at least one of (lore|name|type) must be specified. Items found are not removed.",
                                type: "object",
                                defaultProperties: [],
                                additionalProperties:false,
                                properties: {
                                    lore: {
                                        propertyOrder: 1,
                                        title: "lore",
                                        description: "Matches if any line of lore text *contains* this string.",
                                        type: "string"
                                    },
                                    name: {
                                        propertyOrder: 2,
                                        title: "name",
                                        description: "Matches if the item name *contains* this string.",
                                        type: "string"
                                    },
                                    type: {
                                        propertyOrder: 3,
                                        title: "type",
                                        description: "Matches if the item type is exactly this Material. List of available materials can be found here: https://hub.spigotmc.org/javadocs/spigot/org/bukkit/Material.html",
                                        type: "string"
                                    },
                                    count: {
                                        propertyOrder: 4,
                                        title: "count",
                                        description: "The minimum number of items matching the specified lore/name/type that must be present to succeed. If 0, will succeed only if no matched items are present. This will match items in multiple stacks, for example a stack of 5 and a stack of 8 will match a count of 10.",
                                        type: "integer",
                                        minimum: 1,
                                        default: 1
                                    }
                                }
                            }
                        }
                    }
                },
                actions: {
                    title: "actions",
                    type: "array",
                    minItems: 1,
                    items: {
                        title: "Action",
                        type: "object",
                        defaultProperties: [
                          "dialog"
                        ],
                        additionalProperties:false,
                        properties: {
                            dialog: {
                                title: "dialog",
                                description: "formatting supported with &amp; and ยง, and @S becomes the player's name",
                                type: "object",
                                defaultProperties: [
                                  "text"
                                ],
                                properties: {
                                    text: {
                                        title: "text",
                                        description: "Text spoken by NPC. '[Name] ' part is handled by the plugin",
                                        options: {
                                            "keep_oneof_values":false
                                        },
                                        oneOf: [
                                            {
                                                title: "One line",
                                                type: "string"
                                            },
                                            {
                                                title: "Multiple lines",
                                                type: "array",
                                                minItems: 2,
                                                items: {
                                                    title: "A line",
                                                    type: "string"
                                                }
                                            }
                                        ]
                                    },
                                    raw_text: {
                                        title: "raw_text",
                                        description: "No name or formatting included by default",
                                        options: {
                                            "keep_oneof_values":false
                                        },
                                        oneOf: [
                                            {
                                                title: "One line",
                                                type: "string"
                                            },
                                            {
                                                title: "Multiple lines",
                                                type: "array",
                                                minItems: 2,
                                                items: {
                                                    title: "A line",
                                                    type: "string"
                                                }
                                            }
                                        ]
                                    },
                                    clickable_text: {
                                        title: "clickable_text",
                                        description: "Colored, formatted, and put in [] for you.",
                                        type: "array",
                                        format: "tabs",
                                        minItems: 1,
                                        items: {
                                            headerTemplate: "{{self.player_text}}",
                                            type: "object",
                                            defaultProperties: [
                                              "player_text",
                                              "actions"
                                            ],
                                            properties: {
                                                player_text: {
                                                    required: true,
                                                    propertyOrder: 1,
                                                    title: "player_text",
                                                    description: "Player's response",
                                                    type: "string"
                                                },
                                                delay_actions_by_ticks: {
                                                    propertyOrder: 2,
                                                    $ref: "#/definitions/delay_actions_by_ticks"
                                                },
                                                actions: {
                                                    required: true,
                                                    propertyOrder: 3,
                                                    $ref: "#/definitions/actions"
                                                }
                                            }
                                        }
                                    },
                                    random_text: {
                                        title: "random_text",
                                        type: "array",
                                        minItems: 2,
                                        items: {
                                            title: "A random line",
                                            type: "string"
                                        }
                                    }
                                }
                            },
                            set_scores: {
                                title: "set_scores",
                                description: "Set the player's specified scoreboard value(s). Click Properties, then type in the scoreboard name in the input box and click the 'add' button. Scoreboards are case-sensitive",
                                type: "object",
                                patternProperties:{
                                  ".*":{
                                    $ref: "#/definitions/set_score"
                                  }
                                }
                            },
                            function: {
                                title: "function",
                                description: "Runs a function via the console as the player (/execute <playername> ~ ~ ~ function <function>)",
                                type: "string"
                            },
                            command: {
                                title: "command",
                                description: "Runs a command via the console. Any instance of '@S' (uppercase!) will be replaced with the player's name.",
                                type: "string"
                            },
                            rerun_components: {
                                title: "rerun_components",
                                description: "Re-runs all quest components tied to this specific NPC (including those specified in other files). To prevent infinite loops, this action will run itself, even if conditions indicate it should.",
                                type: "null"
                            }
                        }
                    }
                },
                delay_actions_by_ticks: {
                    title: "delay_actions_by_ticks",
                    type: "integer",
                    minimum: 1
                },
                check_score: {
                    headerTemplate: "{{i}}",
                    options: {
                        "keep_oneof_values":false
                    },
                    oneOf: [
                      {
                        title: "Exactly",
                        $ref: "#/definitions/score"
                      },
                      {
                        title: "Range",
                        type:"object",
                        properties: {
                          min: {
                            title: "Minimum",
                            $ref: "#/definitions/score"
                          },
                          max: {
                            title: "Maximum",
                            $ref: "#/definitions/score"
                          }
                        }
                      },
                      {
                        title: "Matches score",
                        type:"string"
                      }
                    ]
                },
                set_score: {
                    headerTemplate: "{{i}}",
                    options: {
                        "keep_oneof_values":false
                    },
                    oneOf: [
                      {
                        title: "Exactly",
                        $ref: "#/definitions/score"
                      },
                      {
                        title: "Random",
                        type:"object",
                        properties: {
                          min: {
                            title: "Minimum",
                            $ref: "#/definitions/score"
                          },
                          max: {
                            title: "Maximum",
                            $ref: "#/definitions/score"
                          }
                        }
                      },
                      {
                        title: "Copy from",
                        type:"string"
                      }
                    ]
                },
                score: {
                    type: "integer",
                    minimum: -2147483648,
                    maximum: 2147483647
                }
            }
        }
    });

    // Hook up the Restore to Default button
    document.getElementById('restore').addEventListener('click',function() {
        editor.setValue(starting_value);
    });

    // Hook up the validation indicator to update its
    // status whenever the editor changes
    editor.on('change',function() {
        // Get an array of errors from the validator
        var errors = editor.validate();

        var indicator = document.getElementById('valid_indicator');

        // Not valid
        if(errors.length) {
            indicator.className = 'label label-danger'
            indicator.textContent = "not valid";
        }
        // Valid
        else {
            indicator.className = 'label label-success'
            indicator.textContent = "valid";
        }
    });
</script>
</body>
</html>
